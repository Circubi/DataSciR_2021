---
title: "analysis-correlation"
author: "Frank Dreyer"
date: "19 6 2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  echo = TRUE, 
  eval = FALSE, 
  message = FALSE,
  warning = FALSE
)

data_dir <- "../data"
tweets_dir <- data_dir %>% paste("tweets", sep = "/")
sentiments_dir <- data_dir %>% paste("sentiments", sep = "/")
```


```{r load_nba_stats, eval = TRUE}
player_metadata <- paste(data_dir,"player-metadata.csv", sep ="/") %>% read_csv()
player_game_stats <- paste(data_dir,"player-game-stats.csv", sep ="/") %>% read_csv()
game_metadata <- paste(data_dir,"game-metadata.csv", sep ="/") %>% read_csv()
player_season_stats <- paste(data_dir,"player-season-stats.csv", sep ="/") %>% read_csv()
```


```{r load_tweets, eval = TRUE}
tweets <- list.files(tweets_dir, full.names = TRUE) %>% 
  map_dfr(read_csv)

prep_tweets <- data_dir %>% 
  paste("prep-tweets.csv", sep = "/") %>% 
  read_csv()
```


```{r load_sentiments, eval = TRUE}
sentiment_names <- c("bing", "syuzhet", "jockers_rinker", "afinn", "nrc", "novak_emoji")

sentiments <- sentiment_names %>% 
  map_dfr(~ {
    sentiment_name <- .x
    
    sentiment_file <- sentiments_dir %>% 
      paste(sentiment_name, sep = "/") %>% 
      paste0(".csv") %>% 
      str_replace("_", "-")
    
    sentiments_tmp <- read_csv(sentiment_file) %>% 
      mutate(positive_sentiment = if_else(ave_sentiment >= 0, TRUE, FALSE)) %>% 
      mutate(sentiment_lexicon = sentiment_name)
      
  })

sentiments %>% 
  pivot_wider(id_cols = id, names_from = sentiment_lexicon, values_from = ave_sentiment)
```


```{r filter_tweets_24h_before_games, eval = TRUE}
tweets_with_game_timediff <- player_game_stats %>%
  inner_join(game_metadata) %>% 
  inner_join(tweets) %>% 
  mutate(h_timediff_game = as.double(DateTime - created_at, units = "hours")) %>% 
  select(c(names(tweets), h_timediff_game)) 

tweets_24h_before_games <- tweets_with_game_timediff %>%
  filter(h_timediff_game <= 24)
```


```{r compute_sentiment_aggregates_24h_before_games, eval = TRUE}
sentiment_aggregates_24h_before_games <- tweets_24h_before_games %>% 
  inner_join(sentiments) %>% 
  group_by(BBRef_Player_ID, BBRef_Game_ID, sentiment_lexicon) %>% 
  summarise(
    avg_sentiment = mean(ave_sentiment),
    avg_positive_sentiment = sum(positive_sentiment * ave_sentiment) / sum(positive_sentiment), 
    avg_negative_sentiment = sum((!positive_sentiment) * ave_sentiment) / sum(!positive_sentiment),
    rel_freq_positive = sum(positive_sentiment) / n(), 
    rel_freq_negative = sum(!positive_sentiment) / n()
  ) 

sentiment_aggregates_24h_before_games
```


```{r sentiments_BPM_plotting, eval = TRUE, message = TRUE, fig.width = 10, fig.height = 30}
player_metadata %>% 
  inner_join(player_game_stats) %>% 
  inner_join(sentiment_aggregates_24h_before_games) %>% 
  mutate(avg_sentiment = if_else(sentiment_lexicon == "afinn", avg_sentiment / 5, avg_sentiment)) %>%
  ggplot(mapping = aes(x = avg_negative_sentiment, y = BPM)) + 
    geom_point(alpha = 0.2) + 
    geom_smooth(method = "lm", se = FALSE, color = "red") + 
    xlim(-2.5, 0) + 
    facet_grid(Player ~ sentiment_lexicon)
```


```{r pearson_cor, eval = TRUE, message = TRUE}
sentiment_aggregates_24h_before_games %>% 
  pivot_wider(
    id_cols = c(BBRef_Player_ID, BBRef_Game_ID), 
    names_from = sentiment_lexicon, 
    values_from = avg_sentiment
  ) %>% 
  inner_join(player_game_stats) %>% 
  inner_join(player_metadata) %>% 
  group_by(Player) %>% 
  group_modify(~ {
    tibble(
      corr_jockers_rinker_BPM = cor(.x$jockers_rinker, .x$BPM, use = "complete.obs"),
      corr_nrc_BPM = cor(.x$nrc, .x$BPM, use = "complete.obs"),
      corr_afinn_BPM = cor(.x$afinn, .x$BPM, use = "complete.obs"),
      corr_novak_emoji_BPM = cor(.x$novak_emoji, .x$BPM, use = "complete.obs")
    )
  })
```


Observation: On extremely positive sentiment values (outliers) the player had birthday. 

```{r birthday_outliers, eval = TRUE, message = TRUE}
sentiment_aggregates_24h_before_games %>% 
  filter(sentiment_lexicon == "nrc") %>% 
  group_by(BBRef_Player_ID) %>% 
  top_n(1, avg_sentiment) %>% 
  select(c(BBRef_Player_ID, BBRef_Game_ID)) %>% 
  inner_join(player_metadata) %>% 
  inner_join(tweets) %>% 
  filter(Player == "Draymond Green") %>% 
  select(c(Player, created_at, text))
```


```{r season_18_19_trend_BPM_vs_jockers_rinker, eval = TRUE, message = TRUE, fig.width = 10, fig.height = 80}
scaling_coef <- 60

player_metadata %>% 
  inner_join(player_game_stats) %>% 
  inner_join(sentiment_aggregates_24h_before_games) %>% 
  filter(SeasonType == "Regular Season") %>% 
  filter(Season %in% c("2018-19")) %>% 
  filter(sentiment_lexicon == "jockers_rinker") %>% 
  rename(jockers_rinker = avg_sentiment) %>% 
  ggplot(mapping = aes(x = Date)) +
  
    geom_smooth(mapping = aes(y = BPM), se = FALSE, color = "blue") + 
    geom_line(mapping = aes(y = BPM), color = "blue", alpha = 0.2) + 
  
    geom_smooth(mapping = aes(y = jockers_rinker * scaling_coef), se = FALSE, color = "red") +
    geom_line(mapping = aes(y = jockers_rinker * scaling_coef), color = "red", alpha = 0.2) + 
  
    facet_wrap(~ Player, ncol = 1) +
  
    scale_y_continuous( 
      name = "BPM",
      sec.axis = sec_axis(~./scaling_coef, name = "Jockers/Rinker")
    ) + 
    coord_cartesian(ylim = c(-10,20)) + 
    theme_minimal() + 
    theme(
      axis.title.y = element_text(color = "blue"),
      axis.title.y.right = element_text(color = "red")
    )
```

