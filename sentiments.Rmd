---
title: "sentiments"
output: html_document
---
```{r packages, message = FALSE}
library(rvest)
library(stringr)
library(tidyverse)
library(syuzhet)
library(Unicode) 
library(stringi) 

data_dir <- "data"
tweets_dir <- data_dir %>% paste("tweets", sep = "/")
```


```{r load_nba_stats}
player_metadata <- paste(data_dir,"player-metadata.csv", sep ="/") %>% read_csv()
player_game_stats <- paste(data_dir,"player-game-stats.csv", sep ="/") %>% read_csv()
game_metadata <- paste(data_dir,"game-metadata.csv", sep ="/") %>% read_csv()
player_season_stats <- paste(data_dir,"player-season-stats.csv", sep ="/") %>% read_csv()
```


```{r load_tweets}
tweets <- list.files(tweets_dir, full.names = TRUE) %>% 
  map_dfr(read_csv)

tweets <- player_metadata %>% inner_join(tweets)

tweets
```


```{r emoji_lexicon}
# get the emoji unicode and sentiment score
emojis_url <- "http://kt.ijs.si/data/Emoji_sentiment_ranking/index.html"
content <- read_html(emojis_url)

table <- content %>%
  html_element("table") %>% 
  html_table() 

emoji_lexicon <- table %>%
  select(Unicodecodepoint, `Sentiment score[-1...+1]`) %>%
  set_names("unicode","sentiment_score") %>%
  mutate(unicode = as.u_char(unicode)) %>%
  mutate(unicode = str_replace(unicode,"U","")) %>%
  mutate(unicode = str_replace(unicode,"[+]","")) %>%
  set_names("word","value")

emoji_lexicon
```


```{r tmp_subset_tweets}
tweets <- tweets %>% 
  filter(Twitter == "KlayThompson") %>% 
  head(500)

```


```{r sentiment}
# Function to get the emoticon sentiment score for a tweet
get_sentiment_emoji <- function(text){
  unicode <- text %>% str_extract_unicodes()
  
  tibble(unicode = unicode) %>%
    inner_join(emoji_lexicon, by = c("unicode" = "word")) %>%
    summarize(mean = mean(value, na.rm = TRUE)) %>%
    pull()
}

# Function to extract unicodes from a string
str_extract_unicodes <- function(text){
  unicodes <- text %>% 
    stri_escape_unicode() %>% 
    str_extract_all("\\\\[Uu][0-9a-zA-Z]{4,8}") %>% 
    unlist() %>% 
    str_remove("\\\\[Uu]0*") %>% 
    str_to_upper()
  
  print(text)
  print(unicodes)
}

# add sentiments for each tweet
sentiment_df <- tweets %>%
  mutate(bing = map_dbl(tweets$text, ~ get_sentiment(.x, method = "bing"))) %>%
  mutate(afinn = map_dbl(tweets$text, ~ get_sentiment(.x, method ="afinn"))) %>%
  mutate(nrc = map_dbl(tweets$text, ~ get_sentiment(.x, method ="nrc"))) %>%
  mutate(syuzhet = map_dbl(tweets$text, ~ get_sentiment(.x, method ="syuzhet"))) %>% 
  mutate(emoji = map_dbl(tweets$text, get_sentiment_emoji))

sentiment_df %>% group_by(BBRef_Player_ID, BBRef_Game_ID) %>% 
  summarise(
    bing = mean(bing),
    afinn = mean(afinn),
    nrc = mean(nrc),
    syuzhet = mean(syuzhet),
    emoji = mean(emoji, na.rm = TRUE)
  )

```