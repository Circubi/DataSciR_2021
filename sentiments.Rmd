---
title: "sentiments"
output: html_document
---
```{r packages, message = FALSE}
library(rvest)
library(stringr)
library(tidyverse)
library(syuzhet)
library(Unicode) 
library(stringi) 
```


```{r load_data}
mainDir <- "./data/" 
tweets <- read_csv(paste(mainDir,"/tweets/tweets.csv", sep =""))
```


```{r emoji_lexicon}
# get the emoji unicode and sentiment score
emojis_url <- "http://kt.ijs.si/data/Emoji_sentiment_ranking/index.html"
content <- read_html(emojis_url)

table <- content %>%
  html_element("table") %>% 
  html_table() 

emoji_lexicon <- table %>%
  select(Unicodecodepoint, `Sentiment score[-1...+1]`) %>%
  set_names("unicode","sentiment_score") %>%
  mutate(unicode = as.u_char(unicode)) %>%
  mutate(unicode = str_replace(unicode,"U","")) %>%
  mutate(unicode = str_replace(unicode,"[+]","")) %>%
  set_names("word","value")
```


```{r tmp_subset_tweets}

tweets <- tweets %>% 
  filter(Player == "KlayThompson") %>% 
  head(100)

```


```{r sentiment}
# Function to get the emoticon sentiment score for a tweet
get_sentiment_emoji <- function(text){
  emojis <- text %>% get_emojis()
  
  tibble(unicode = emojis) %>%
    inner_join(emoji_lexicon, by = c("unicode" = "word")) %>%
    summarize(sum = sum(value)) %>%
    pull()
}

# Function to extract emojis from a tweet
get_emojis <- function(text){
  emojis <- text %>% 
    str_replace_all(">", "> ") %>% 
    str_replace_all("<", " <") %>% 
    str_extract_all("(?<=^|\\s)<[^\\s]+") %>% 
    unlist() %>% 
    str_replace_all("<U","") %>%
    str_replace_all("[+]","") %>%
    str_replace_all(">","") %>% 
    str_replace_all("000","") %>%
    str_to_upper()
}

# add sentiments for each tweet
sentiment_df <- tweets %>%
  mutate(bing = map_dbl(tweets$text, ~ get_sentiment(.x, method = "bing"))) %>%
  mutate(afinn = map_dbl(tweets$text, ~ get_sentiment(.x, method ="afinn"))) %>%
  mutate(nrc = map_dbl(tweets$text, ~ get_sentiment(.x, method ="nrc"))) %>%
  mutate(syuzhet = map_dbl(tweets$text, ~ get_sentiment(.x, method ="syuzhet"))) %>% 
  mutate(emoji = map_dbl(tweets$text, get_sentiment_emoji))

sentiment_df %>% group_by(Player, GameId) %>% 
  summarise(
    bing = sum(bing),
    afinn = sum(afinn),
    nrc = sum(nrc),
    syuzhet = sum(syuzhet),
    emoji = sum(emoji)
  )

```