---
title: 'Dataset Generation: NBA Player Statistics'
author: "Frank Dreyer, Jannik Greif, Kolja GÃ¼nther"
date: "23 5 2021"
output: html_document
---

# Introduction

To create the final dataset for our analysis one part is the extraction of game statistics from selected NBA players. In the following we will describe how to extract this kind of information from [basketball-reference.com](https://basketball-reference.com), a site which provides historized basketball statistics of basketball players and teams from varous US American and European leagues including the NBA.  

## Setup

Before getting started let's first set up our environment. To extract the data from [basketball-reference.com](https://basketball-reference.com) we will will extensively use the web scraping library `rvest` in addition to the `tidyverse`.

```{r setup, warning = FALSE, message = FALSE}
library(tidyverse)
library(rvest)
```


## Extracting NBA Players with existing Twitter Accounts

With our final game statistics dataset we want to be able to link game statistics of players to tweets they received on the same day before a game. For that reason we should only consider NBA players that have an existing Twitter account. Fortunately for us, [basketball-reference.com](https://basketball-reference.com) provides a list of [Twitter usernames of NBA players](https://www.basketball-reference.com/friv/twitter.html). Let's use this information and load it into a dataframe.

```{r twitter-accounts}
url_twitter_accounts <- "https://www.basketball-reference.com/friv/twitter.html"

twitter_tbl <- read_html(url_twitter_accounts) %>% 
  html_element("table.stats_table") 

player_td = twitter_tbl %>% 
  html_elements("td[data-stat=\"player\"]") 

twitter_td = twitter_tbl %>% 
  html_elements("td[data-stat=\"twitter\"]")

player_bref_ids = player_td %>% 
  html_element("a") %>% 
  html_attr("href") %>% 
  map_chr(~ str_extract(.x, "[a-z]/[a-z]+[0-9]{2}"))

player_names = player_td %>% html_text(trim = TRUE)

twitter_names = twitter_td %>% html_text(trim = TRUE)

twitter_accounts <- tibble(
  bref_id = player_bref_ids,
  player = player_names,
  twitter = twitter_names
)

twitter_accounts %>% write_csv("data/player-twitter-accounts.csv")

twitter_accounts
```


## Extracting Game Statistics from NBA players with existing Twitter Accounts

Having all NBA players including their twitter names loaded into a dataframe we are now ready to extract game statistics for each player. To do that let's write a function that gets a player's basketball-reference id as input and returns a tibble including all the game statistics of games he played in from [basketball-reference.com](https://basketball-reference.com). 

```{r playerseasonstats}
get_player_season_stats <- function(bref_id) {
  
  url <- glue::glue("https://www.basketball-reference.com/players/{bref_id}.html")
  html <- read_html(url)
  
  html_regular_season_tbl <- html %>% html_node("table#per_game")
  html_playoffs_tbl <- html %>% html_node("table#playoffs_per_game")
  
  player_name <- html %>% 
    html_element("h1[itemprop=\"name\"]") %>% 
    html_text() %>% str_trim() 
  
  player_season_stats <- NULL
  
  # If player participated in regular season
  if (!is.na(html_regular_season_tbl)) {
    player_season_stats <- html_regular_season_tbl %>% 
      html_table(trim = TRUE, convert = FALSE) %>% 
      mutate(SeasonType = "Regular Season", .after = Season)
  }
  
  # If player participated in playoffs
  if (!is.na(html_playoffs_tbl)) {
    player_season_stats <- bind_rows(
      player_season_stats,
      html_playoffs_tbl %>% 
        html_table(trim = TRUE, convert = FALSE) %>% 
        mutate(SeasonType = "Playoffs", .after = Season)
    )
  }
  
  # If player either played in regular season or playoffs
  if (!is.null(player_season_stats)){
    player_season_stats <- player_season_stats %>% 
      filter(str_detect(Season, "[0-9]{4}-[0-9]{2}")) %>%   
      mutate(bref_id = bref_id, .before = Season) %>% 
      mutate(Player = player_name, .after = bref_id) %>% 
      naniar::replace_with_na_all(
        condition = ~ str_detect(.x, "Did Not Play")
      ) %>% 
      type.convert(as.is = TRUE)
  }
  
  player_season_stats
  
}

player_season_stats <- twitter_accounts$bref_id %>% 
  map_dfr(get_player_season_stats)

player_season_stats %>% 
  write_csv("data/player-season-stats.csv")

player_season_stats
```


